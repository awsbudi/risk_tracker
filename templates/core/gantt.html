{% extends 'core/base.html' %}
{% block content %}
<div class="mb-3">
    <h2>Gantt Chart Timeline</h2>
</div>

<div class="alert alert-info py-2 mb-3">
    <small>üí° <strong>Tip:</strong> Grafik otomatis fokus ke hari ini. Scroll ke kiri untuk melihat riwayat sebelumnya.</small>
</div>

<!-- 1. CONTAINER CHART -->
<div class="card p-3 shadow-sm mb-3">
    <!-- Tambahkan ID pada container agar mudah di-select JS -->
    <div id="chart-scroll-container" class="gantt-scroll-container" style="overflow-x: auto; white-space: nowrap; position: relative; min-height: 400px;">
        <svg id="gantt"></svg>
    </div>
</div>

<!-- 2. CONTROL PANEL (LAYOUT BARU: KIRI & BERTUMPUK) -->
<div class="card bg-light border-0 shadow-sm">
    <div class="card-body">
        
        <!-- Wrapper Kolom ke Bawah (Vertical Stack) -->
        <div class="d-flex flex-column gap-3 align-items-start">
            
            <!-- Baris 1: View Mode -->
            <div class="d-flex align-items-center gap-2">
                <label for="viewModeSelect" class="fw-bold text-secondary mb-0" style="min-width: 90px;">üëÅÔ∏è View:</label>
                <select class="form-select form-select-sm" style="width: 200px;" id="viewModeSelect" onchange="changeViewMode(this.value)">
                    <option value="Day">Harian (Day)</option>
                    <option value="Week" selected>Mingguan (Week)</option>
                    <option value="Month">Bulanan (Month)</option>
                    <option value="Half Day">Per 12 Jam</option>
                    <option value="Quarter Day">Per 6 Jam</option>
                </select>
            </div>

            <!-- Baris 2: Actions (Download & Navigasi) -->
            <div class="d-flex align-items-center gap-2">
                <label class="fw-bold text-secondary mb-0" style="min-width: 90px;">Actions:</label>
                
                <!-- Download -->
                <button id="btnDownload" class="btn btn-success btn-sm d-flex align-items-center gap-1" onclick="downloadExcel()">
                    <span>üì•</span> Excel
                </button>
                
                <div class="vr mx-2"></div> <!-- Pembatas Vertikal -->

                <!-- Navigasi Geser -->
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="scrollChart(-300)" title="Geser Kiri (Mundur)">
                        ‚¨ÖÔ∏è Back
                    </button>
                    <button class="btn btn-dark btn-sm" onclick="scrollToToday()" title="Ke Hari Ini">
                        üìç Today
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="scrollChart(300)" title="Geser Kanan (Maju)">
                        Next ‚û°Ô∏è
                    </button>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    /* Styling Custom untuk Gantt */
    .bar-project .bar { fill: #6f42c1 !important; }
    .bar-project .bar-progress { fill: #563d7c !important; }
    .bar-wrapper { cursor: move; }
    
    .gantt-scroll-container {
        scroll-behavior: smooth;
        background-color: #fff;
    }

    .gantt .grid-header .tick text {
        font-size: 12px;
        fill: #555;
        font-weight: 500;
    }
    
    /* Highlight kolom hari ini agar lebih jelas */
    .today-highlight {
        fill: #fff9c4 !important; /* Warna kuning muda */
        opacity: 0.5;
    }
</style>

<script>
    var ganttChart = null;
    var tasksData = [];

    // --- 1. FUNGSI SCROLL MANUAL ---
    function scrollChart(amount) {
        const container = document.getElementById('chart-scroll-container');
        if (container) container.scrollLeft += amount;
    }

    // --- 2. FUNGSI SCROLL OTOMATIS KE HARI INI ---
    function scrollToToday() {
        const container = document.getElementById('chart-scroll-container');
        if (!container) return;

        // Cari elemen 'today' highlight bawaan Frappe Gantt atau hitung manual
        // Frappe Gantt menandai hari ini dengan elemen <rect> atau <path> class 'today-highlight'
        // Namun, kita akan gunakan pendekatan kalkulasi posisi Header Text yang cocok dengan tanggal/bulan ini.
        
        // Kita delay sedikit karena SVG butuh waktu render
        setTimeout(() => {
            const today = new Date();
            const viewMode = document.getElementById('viewModeSelect').value;
            
            // Nama Bulan dalam Bahasa Inggris (Default Frappe)
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const currentMonthName = monthNames[today.getMonth()];
            const currentYear = today.getFullYear();
            
            // Cari text di header grid yang sesuai
            const headerTexts = document.querySelectorAll('.grid-header text');
            let targetX = 0;
            let found = false;

            if (viewMode === 'Month') {
                // Cari teks seperti "January", "Feb", dll
                // Frappe Gantt Month view biasanya menampilkan "YYYY" di atas dan "Jan", "Feb" di bawah atau sebaliknya.
                // Kita cari teks yang mengandung nama bulan ini ATAU singkatan (Jan, Feb, Mar...)
                const shortMonth = currentMonthName.substring(0, 3);
                
                headerTexts.forEach(text => {
                    if (!found && (text.innerHTML.includes(currentMonthName) || text.innerHTML.includes(shortMonth))) {
                        // Pastikan tahunnya juga relevan jika ada (opsional, simple check dulu)
                        // Ambil koordinat X
                        targetX = parseFloat(text.getAttribute('x'));
                        found = true;
                    }
                });
            } else {
                // Untuk Day/Week, kita cari highlight 'Hari Ini'
                // Frappe Gantt punya highlight Today
                const todayHighlight = document.querySelector('.today-highlight');
                if (todayHighlight) {
                    targetX = parseFloat(todayHighlight.getAttribute('x'));
                    found = true;
                }
            }

            // Eksekusi Scroll
            if (found) {
                // Kurangi sedikit (misal 50px) agar tidak terlalu mepet kiri
                container.scrollLeft = targetX - 50;
            } else {
                // Fallback: Jika tidak ketemu (misal data chart jauh di masa depan/lalu),
                // scroll ke paling kanan atau biarkan 0.
                console.log("Posisi hari ini tidak ditemukan di chart.");
            }
        }, 300); // Delay 300ms pasca render
    }

    // --- 3. FUNGSI GANTI VIEW ---
    function changeViewMode(mode) {
        if (ganttChart) {
            ganttChart.change_view_mode(mode);
            scrollToToday(); // Auto scroll setiap ganti view
        }
    }

    // --- 4. DOWNLOAD EXCEL ---
    let isExporting = false;
    function downloadExcel() {
        if (isExporting) return;
        isExporting = true;
        
        const btn = document.getElementById('btnDownload');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = "‚è≥ Generating...";

        window.location.href = "{% url 'gantt-export' %}";

        setTimeout(() => {
            isExporting = false;
            btn.disabled = false;
            btn.innerHTML = originalText;
        }, 5000);
    }

    // --- 5. LOAD CHART ---
    function loadGantt() {
        const container = document.getElementById('gantt');
        container.innerHTML = "";
        
        fetch("/gantt/data/")
            .then(response => {
                if (!response.ok) throw new Error("Gagal mengambil data");
                return response.json();
            })
            .then(data => {
                tasksData = data;
                if(data.length > 0) {
                    ganttChart = new Gantt("#gantt", data, {
                        header_height: 50,
                        column_width: 30,
                        step: 24,
                        view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                        bar_height: 25,
                        bar_corner_radius: 3,
                        arrow_curve: 5,
                        padding: 18,
                        view_mode: 'Week', 
                        date_format: 'YYYY-MM-DD',
                        popup_trigger: 'click mouseover',
                        
                        on_date_change: function(task, start, end) {
                            if (task.id.startsWith('PROJ')) {
                                alert("Tanggal Proyek hanya bisa diubah lewat menu Edit Proyek.");
                                window.location.reload(); 
                                return; 
                            }
                            const formatDate = (d) => {
                                let month = '' + (d.getMonth() + 1),
                                    day = '' + d.getDate(),
                                    year = d.getFullYear();
                                if (month.length < 2) month = '0' + month;
                                if (day.length < 2) day = '0' + day;
                                return [year, month, day].join('-');
                            };

                            fetch(`/tugas/${task.id}/update-date/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ start: formatDate(start), end: formatDate(end) })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.reload(); 
                                } else {
                                    alert("Gagal update tanggal: " + data.error);
                                }
                            });
                        },
                        
                        custom_popup_html: function(task) {
                            return `
                            <div class="details-container" style="padding:10px; background:white; border:1px solid #ccc; width: 200px; z-index:1000; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                              <h6 style="margin:0;">${task.name}</h6>
                              <hr style="margin:5px 0;">
                              <small>Start: ${task.start}</small><br/>
                              <small>End: ${task.end}</small><br/>
                              <small>Progress: ${task.progress}%</small>
                            </div>
                            `;
                        }
                    });

                    // Trigger Auto Scroll setelah chart dimuat
                    scrollToToday();

                } else {
                    document.querySelector('.gantt-scroll-container').innerHTML = "<div class='text-center p-5 text-muted'>Belum ada data tugas.</div>";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelector('.gantt-scroll-container').innerHTML = "<p class='text-danger p-3'>Gagal memuat data.</p>";
            });
    }

    loadGantt();
</script>
{% endblock %}
