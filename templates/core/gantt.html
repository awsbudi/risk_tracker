{% extends 'core/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h2>Gantt Chart Timeline</h2>
    
    <!-- FILTER TOOLBAR -->
    <div class="card p-2 bg-light d-flex flex-row align-items-center gap-2">
        <label>Filter:</label>
        <input type="date" id="filterStart" class="form-control form-control-sm" style="width: 140px;">
        <span>s/d</span>
        <input type="date" id="filterEnd" class="form-control form-control-sm" style="width: 140px;">
        <button onclick="applyFilter()" class="btn btn-sm btn-primary">Tampilkan</button>
        <button onclick="resetFilter()" class="btn btn-sm btn-outline-secondary">Reset</button>
    </div>

    <div class="btn-group ms-2">
        <!-- TOMBOL DOWNLOAD -->
        <button class="btn btn-success btn-sm" onclick="downloadExcel()">üì• Download Excel</button>
        
        <!-- NAVIGASI SCROLL -->
        <div class="btn-group ms-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="scrollChart(-200)" title="Geser Kiri">‚¨ÖÔ∏è</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="scrollChart(200)" title="Geser Kanan">‚û°Ô∏è</button>
        </div>
    </div>
</div>

<div class="alert alert-info py-2">
    <small>üí° <strong>Tip:</strong> Gunakan filter tanggal untuk melihat periode spesifik. Klik 'Download Excel' untuk laporan.</small>
</div>

<!-- CONTAINER SCROLLABLE -->
<div class="card p-3 shadow-sm">
    <div class="gantt-scroll-container" style="overflow-x: auto; white-space: nowrap; position: relative;">
        <div id="gantt"></div>
    </div>
</div>

<style>
    .bar-project .bar { fill: #6f42c1 !important; }
    .bar-project .bar-progress { fill: #563d7c !important; }
    .bar-wrapper { cursor: move; }
    .gantt-scroll-container {
        scroll-behavior: smooth;
        border: 1px solid #eee;
        border-radius: 4px;
        min-height: 400px;
        background-color: #fff;
    }
</style>

<script>
    function scrollChart(amount) {
        const container = document.querySelector('.gantt-scroll-container');
        if (container) container.scrollLeft += amount;
    }

    function getFilterParams() {
        const start = document.getElementById('filterStart').value;
        const end = document.getElementById('filterEnd').value;
        if (start && end) return `?start=${start}&end=${end}`;
        return "";
    }

    function applyFilter() {
        loadGantt(getFilterParams());
    }

    function resetFilter() {
        document.getElementById('filterStart').value = "";
        document.getElementById('filterEnd').value = "";
        loadGantt("");
    }

    function downloadExcel() {
        const params = getFilterParams();
        window.location.href = "{% url 'gantt-export' %}" + params;
    }

    function loadGantt(queryParams) {
        const container = document.getElementById('gantt');
        container.innerHTML = ""; // Clear old chart
        
        fetch("/gantt/data/" + queryParams)
            .then(response => {
                if (!response.ok) throw new Error("Gagal mengambil data dari server");
                return response.json();
            })
            .then(data => {
                if(data.length > 0) {
                    var gantt = new Gantt("#gantt", data, {
                        header_height: 50,
                        column_width: 30,
                        step: 24,
                        view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                        bar_height: 25,
                        bar_corner_radius: 3,
                        arrow_curve: 5,
                        padding: 18,
                        view_mode: 'Week', 
                        date_format: 'YYYY-MM-DD',
                        popup_trigger: 'click mouseover',
                        
                        on_date_change: function(task, start, end) {
                            if (task.id.startsWith('PROJ')) {
                                alert("Tanggal Proyek hanya bisa diubah lewat menu Edit Proyek.");
                                window.location.reload(); 
                                return; 
                            }
                            const formatDate = (d) => {
                                let month = '' + (d.getMonth() + 1),
                                    day = '' + d.getDate(),
                                    year = d.getFullYear();
                                if (month.length < 2) month = '0' + month;
                                if (day.length < 2) day = '0' + day;
                                return [year, month, day].join('-');
                            };

                            fetch(`/tugas/${task.id}/update-date/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ start: formatDate(start), end: formatDate(end) })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.reload(); 
                                } else {
                                    alert("Gagal update tanggal: " + data.error);
                                }
                            });
                        },
                        
                        custom_popup_html: function(task) {
                            return `
                            <div class="details-container" style="padding:10px; background:white; border:1px solid #ccc; width: 200px; z-index:1000;">
                              <strong>${task.name}</strong><br/>
                              <small>${task.start} - ${task.end}</small><br/>
                              Progress: ${task.progress}%
                            </div>
                            `;
                        }
                    });
                } else {
                    container.innerHTML = "<p class='text-muted p-3'>Tidak ada data tugas untuk periode ini.</p>";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = "<p class='text-danger p-3'>Gagal memuat data Gantt Chart.</p>";
            });
    }

    // Load initial
    loadGantt("");
</script>
{% endblock %}