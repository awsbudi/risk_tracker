{% extends 'core/base.html' %}

{% block content %}
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            {% if form.instance.pk %}Edit Tugas: {{ form.instance.kode_tugas }}{% else %}Buat Tugas Baru{% endif %}
        </h2>
        <a href="{% url 'tugas-list' %}" class="btn btn-outline-secondary">Kembali</a>
    </div>

    <form method="post" class="card shadow-sm border-0">
        {% csrf_token %}
        <div class="card-body p-4">
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
            {% endif %}

            <!-- SECTION 1: INFO DASAR -->
            <h5 class="text-primary border-bottom pb-2 mb-3">Informasi Tugas</h5>
            
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label fw-bold">Nama Tugas</label>
                    {{ form.nama_tugas }}
                    {{ form.nama_tugas.errors }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Tipe Tugas</label>
                    {{ form.tipe_tugas }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Proyek (Wajib jika tipe Proyek)</label>
                    {{ form.proyek }} <!-- UAT: Dropdown Quick Search (akan diaktifkan via JS dibawah) -->
                    {{ form.proyek.errors }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Pemberi Tugas (Wajib jika Adhoc)</label>
                    {{ form.pemberi_tugas }}
                    {{ form.pemberi_tugas.errors }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Induk Tugas (Opsional)</label>
                    {{ form.induk }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tergantung Pada (Opsional)</label>
                    {{ form.tergantung_pada }}
                </div>
            </div>

            <!-- SECTION 2: JADWAL (PLAN VS ACTUAL) -->
            <!-- UAT: Memisahkan Plan & Actual -->
            <div class="row mt-4">
                <!-- PLAN (Kiri) -->
                <div class="col-md-6">
                    <div class="card h-100 bg-light border-0">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="text-primary fw-bold mb-0"><i class="bi bi-calendar-event"></i> RENCANA (PLAN)</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Tanggal Mulai (Plan)</label>
                                {{ form.tanggal_mulai }}
                                {{ form.tanggal_mulai.errors }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tenggat Waktu / Deadline (Plan)</label>
                                {{ form.tenggat_waktu }}
                                {{ form.tenggat_waktu.errors }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ACTUAL (Kanan) -->
                <div class="col-md-6 mt-3 mt-md-0">
                    <div class="card h-100" style="background-color: #f0fff4;">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="text-success fw-bold mb-0"><i class="bi bi-check-circle"></i> REALISASI (ACTUAL)</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Mulai Aktual</label>
                                {{ form.tanggal_mulai_aktual }}
                                <div class="form-text">Diisi saat mulai mengerjakan.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Selesai Aktual</label>
                                {{ form.tanggal_selesai_aktual }}
                                <div class="form-text">Otomatis terisi hari ini jika Status = Selesai.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: EKSEKUSI -->
            <h5 class="text-primary border-bottom pb-2 mt-4 mb-3">Eksekusi & Status</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Ditugaskan Ke (PIC)</label>
                    {{ form.ditugaskan_ke }} <!-- UAT: Quick Search enabled via JS -->
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Progress (%)</label>
                    <div class="input-group">
                        {{ form.progress }}
                        <span class="input-group-text">%</span>
                    </div>
                    {{ form.progress.errors }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Status</label>
                    {{ form.status }}
                </div>
            </div>

            <div class="mt-4 text-end border-top pt-3">
                <button type="submit" class="btn btn-primary px-5 fw-bold">
                    <i class="bi bi-save"></i> SIMPAN TUGAS
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Tambahkan Select2 CSS/JS untuk fitur Quick Search pada Dropdown (UAT Requirement) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        // UAT: Quick Search untuk dropdown list
        $('#id_proyek').select2({ placeholder: "Pilih Proyek...", allowClear: true, width: '100%' });
        $('#id_induk').select2({ placeholder: "Pilih Induk Tugas...", allowClear: true, width: '100%' });
        $('#id_ditugaskan_ke').select2({ placeholder: "Pilih PIC...", width: '100%' });
        $('#id_pemberi_tugas').select2({ placeholder: "Pilih Pemberi Tugas...", width: '100%' });
        $('#id_tergantung_pada').select2({ placeholder: "Pilih Ketergantungan...", allowClear: true, width: '100%' });

        // UAT UX: Auto copy Start Date Plan to Actual Start Date (jika kosong)
        $('#id_tanggal_mulai').change(function(){
            var planStart = $(this).val();
            var actStart = $('#id_tanggal_mulai_aktual').val();
            if(planStart && !actStart) {
                $('#id_tanggal_mulai_aktual').val(planStart);
            }
        });

        // Validasi Tipe Tugas UI
        function toggleFields() {
            var tipe = $('#id_tipe_tugas').val();
            if(tipe === 'ADHOC') {
                $('#id_proyek').prop('disabled', true).val(null).trigger('change');
                $('#id_pemberi_tugas').prop('disabled', false);
            } else if (tipe === 'PROJECT') {
                $('#id_proyek').prop('disabled', false);
                // $('#id_pemberi_tugas').prop('disabled', true).val(null).trigger('change'); // Optional
            } else {
                $('#id_proyek').prop('disabled', true);
            }
        }
        $('#id_tipe_tugas').change(toggleFields);
        toggleFields(); // Run on load
    });
</script>

<!-- Custom Style untuk memperbaiki tampilan Select2 di Bootstrap 5 -->
<style>
    .select2-container .select2-selection--single {
        height: 38px !important;
        border: 1px solid #ced4da !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px !important;
    }
</style>
{% endblock %}
