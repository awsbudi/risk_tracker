{% extends 'core/base.html' %}

{% block content %}
<div class="container py-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
            {% if form.instance.pk %}Edit Tugas: {{ form.instance.kode_tugas }}{% else %}Buat Tugas Baru{% endif %}
        </h2>
        <a href="{% url 'tugas-list' %}" class="btn btn-outline-secondary">Kembali</a>
    </div>

    <!-- Error Message Display -->
    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Gagal Menyimpan!</strong> Periksa isian berikut:
        <ul class="mb-0 mt-2">
        {% for field, errors in form.errors.items %}
            {% for error in errors %}
                <li>
                    {% if field != '__all__' %}
                        <strong>{{ field|title }}:</strong> 
                    {% endif %}
                    {{ error }}
                </li>
            {% endfor %}
        {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <form method="post" class="card shadow-sm border-0" id="taskForm">
        {% csrf_token %}
        <div class="card-body p-4">
            
            <!-- SECTION 1: INFO DASAR -->
            <h5 class="text-primary border-bottom pb-2 mb-3">Informasi Tugas</h5>
            
            <div class="row">
                <div class="col-md-8 mb-3">
                    <label class="form-label fw-bold">Nama Tugas <span class="text-danger">*</span></label>
                    {{ form.nama_tugas }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Tipe Tugas</label>
                    {{ form.tipe_tugas }}
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Proyek (Wajib jika tipe Proyek)</label>
                    {{ form.proyek }} 
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Pemberi Tugas (Wajib jika Adhoc)</label>
                    {{ form.pemberi_tugas }}
                    <datalist id="user-list">
                        {% for user in form.fields.ditugaskan_ke.queryset %}
                            <option value="{{ user.get_full_name|default:user.username }}">
                        {% endfor %}
                    </datalist>
                    <div class="form-text">Ketik nama manual (Direktur/Klien) atau pilih dari list.</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Induk Tugas</label>
                    {{ form.induk }}
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tergantung Pada</label>
                    {{ form.tergantung_pada }}
                </div>
            </div>

            <!-- SECTION 2: JADWAL (PLAN VS ACTUAL) -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card h-100 bg-light border-0">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="text-primary fw-bold mb-0"><i class="bi bi-calendar-event"></i> RENCANA (PLAN)</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Tanggal Mulai (Plan) <span class="text-danger">*</span></label>
                                {{ form.tanggal_mulai }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tenggat Waktu (Plan) <span class="text-danger">*</span></label>
                                {{ form.tenggat_waktu }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mt-3 mt-md-0">
                    <div class="card h-100" style="background-color: #f0fff4;">
                        <div class="card-header bg-transparent border-0 pb-0">
                            <h6 class="text-success fw-bold mb-0"><i class="bi bi-check-circle"></i> REALISASI (ACTUAL)</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Mulai Aktual</label>
                                {{ form.tanggal_mulai_aktual }}
                                <div class="form-text">Diisi saat mulai mengerjakan.</div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Selesai Aktual</label>
                                {{ form.tanggal_selesai_aktual }}
                                <div class="form-text">Otomatis set status Selesai jika diisi.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: EKSEKUSI -->
            <h5 class="text-primary border-bottom pb-2 mt-4 mb-3">Eksekusi & Status</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Ditugaskan Ke (PIC)</label>
                    {{ form.ditugaskan_ke }}
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Progress (%)</label>
                    <div class="input-group">
                        {{ form.progress }}
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">Status</label>
                    {{ form.status }}
                </div>
            </div>

            <div class="mt-4 text-end border-top pt-3">
                <a href="{% url 'tugas-list' %}" class="btn btn-light me-2">Batal</a>
                <button type="submit" class="btn btn-primary px-5 fw-bold" id="btnSimpan">
                    <i class="bi bi-save"></i> SIMPAN TUGAS
                </button>
            </div>
        </div>
    </form>
</div>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        $('#id_proyek').select2({ placeholder: "Pilih Proyek...", allowClear: true, width: '100%' });
        $('#id_induk').select2({ placeholder: "Pilih Induk Tugas...", allowClear: true, width: '100%' });
        $('#id_ditugaskan_ke').select2({ placeholder: "Pilih PIC...", width: '100%' });

        // --- VALIDATION WEEKEND (SABTU/MINGGU) ---
        function checkWeekend(inputElement, label) {
            var val = $(inputElement).val();
            if(!val) return;
            
            var date = new Date(val);
            var day = date.getDay(); // 0 = Minggu, 6 = Sabtu
            
            if(day === 0 || day === 6) {
                alert("Tanggal " + label + " tidak boleh jatuh pada hari libur (Sabtu/Minggu).");
                $(inputElement).val(''); 
            }
        }

        $('#id_tanggal_mulai').change(function() { 
            checkWeekend(this, "Mulai (Plan)"); 
            // Auto copy to actual
            var planStart = $(this).val();
            var actStart = $('#id_tanggal_mulai_aktual').val();
            if(planStart && !actStart) {
                var d = new Date(planStart);
                if(d.getDay() !== 0 && d.getDay() !== 6) {
                    $('#id_tanggal_mulai_aktual').val(planStart);
                }
            }
        });
        
        $('#id_tanggal_mulai_aktual').change(function() { checkWeekend(this, "Mulai (Actual)"); });

        // --- FEATURE: AUTO COMPLETE IF ACTUAL END DATE FILLED ---
        $('#id_tanggal_selesai_aktual').change(function() {
            var actualEnd = $(this).val();
            if(actualEnd) {
                // Set Progress to 100%
                $('#id_progress').val(100);
                // Set Status to DONE
                $('#id_status').val('DONE');
            }
        });

        // --- LOGIKA FORM FIELD TOGGLE ---
        function toggleFields() {
            var tipe = $('#id_tipe_tugas').val();
            if(tipe === 'ADHOC') {
                $('#id_proyek').val(null).trigger('change'); 
                $('#id_proyek').prop('disabled', true); 
            } else if (tipe === 'PROJECT') {
                $('#id_proyek').prop('disabled', false);
            } else {
                $('#id_proyek').prop('disabled', true);
            }
        }
        $('#id_tipe_tugas').change(toggleFields);
        toggleFields();
        
        // --- Loading State ---
        $('#taskForm').submit(function() {
            var btn = $('#btnSimpan');
            btn.prop('disabled', true);
            btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...');
        });
    });
</script>

<style>
    .select2-container .select2-selection--single {
        height: 38px !important;
        border: 1px solid #ced4da !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 36px !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 36px !important;
    }
</style>
{% endblock %}